<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keywords" content="alerting, monitoring, alert, monitor">
    <!-- disable auto fresh every 60 seconds -->
    <!--
    <meta http-equiv="refresh" content="60">
    -->

    <title>数据平台笔记-数据不一致问题排查</title>
    <link rel="stylesheet" href="/theme/css/bootstrap.min.css" >
    <link rel="stylesheet" href="/theme/css/dashboard.css" >
    <link rel="stylesheet" type="text/css" href="/theme/css/style.css" />

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/theme/js/html5shiv.js" type="text/javascript"></script>
    <script src="/theme/js/respond.js" type="text/javascript"></script>
    <![endif]-->

  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="/" style="border-bottom: 0px;">杨昌明的Blog </a>
        </div>
      </div>
    </div>

    <div  class="container-fluid">
        <div class="row">
            <div class="col-sm-12  col-md-12 main">
                <div id="content">
<article>
    <header>
        <h3 class="article-title">
            数据平台笔记-数据不一致问题排查
            <!--<a href="/pages/consistency" rel="bookmark" title="Permalink to 数据平台笔记-数据不一致问题排查">数据平台笔记-数据不一致问题排查</a>-->
        </h3>
        <hr/>
        <div class="article-info">
            日期:&nbsp;2018-03-03&nbsp;|&nbsp;关注我:&nbsp;<a href="http://weibo.com/changmingy" target="_blank">新浪微博</a>
        </div>
    </header>

    <div class="article-content">
        <p>对于突然停电导致系统shutdown，最受伤的就是hbase的数据，完全重启后，会发现hbase的表出问题，要么表不存在，要么存在但是根本写不进去数据。大部分是由于zookeeper中保存的数据和hbase不一致，所以需要从源头进行排查，就是hbase的存储hdfs。</p>
<h4>检查hdfs</h4>
<p>进入hadoop的管理页面http://ibdp-00:50070，会显示错误的blocks信息，如果没有说明hdfs文件没有问题。</p>
<p><img alt="" src="/theme/images/blocks.png"></p>
<p>如果存在问题，就扫描hdfs，根据错误提示删除掉坏的block</p>
<div class="highlight"><pre><span></span>hadoop fsck /  a
hadoop fs  -rm /xxxxx
</pre></div>


<h4>检查HBase</h4>
<p>这个时候在写hbase看看，能否写入，如果还是有问题，先查看hbase日志，如果出现下面所示异常，说明hbase集群状态不一致。</p>
<p><img alt="" src="/theme/images/hbase-error-1.png"></p>
<p>表有问题是，hbase客户端连接时，会不停的重试，默认是35次，可以修改小一点的值（主配置文件hbase.client.retries.number），减少重试次数。</p>
<p><img alt="" src="/theme/images/hbase-error-2.png"></p>
<p>删除zookeeper中的hbase目录，然后重启habse，在zk中自动重新建立目录。</p>
<div class="highlight"><pre><span></span>hbase zkcli
rmr /hbase
hbase-start.sh
</pre></div>


<p>如果还是出现错误，那就对hbase进行状态检查和修复，先查看hbase的管理页面，查看表状态，根据所在节点，在继续查看regin server的log日志。</p>
<p><img alt="" src="/theme/images/region-sever.png"></p>
<p><img alt="" src="/theme/images/hbase-error-3.png"></p>
<p>如上图中的hdfs中没有对应的文件，而habse meta中有数据，不一致，那么使用如下命令先检查一致性，在进行修复，修复后需要重启hbase。</p>
<div class="highlight"><pre><span></span>hbase hbck -details
hbase hbck -fixMeta -fixAssignments
</pre></div>


<p>出现问题，应该先检查日志，根据日志进行判断，而不是瞎猜，浪费时间。</p>
    </div>


</article>
                </div>
            </div>
        </div>
    </div>


    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/theme/js/jquery.min.js"></script>
    <script src="/theme/js/bootstrap.min.js"></script>

    <!-- svg JavaScript================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="/theme/js/svg.jquery.js"></script>
    <script type="text/javascript" src="/theme/js/pygal-tooltips.js"></script>

  </body>
</html>